<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="ramnog">
<title>Debugging • ramnog</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Debugging">
<meta property="og:description" content="ramnog">
<meta property="og:image" content="https://hta-pharma.github.io/ramnog/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary" data-bs-theme="dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">ramnog</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/ramnog.html">Quick Start</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>Overview</h6>
    <a class="dropdown-item" href="../articles/ep_overview.html">Endpoint specification</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Population and outcome</h6>
    <a class="dropdown-item" href="../articles/ep_spec_adam_data.html">ADaM Data</a>
    <a class="dropdown-item" href="../articles/ep_spec_treatment_arms.html">Treatment Arms</a>
    <a class="dropdown-item" href="../articles/ep_spec_population_def.html">Analysis Population</a>
    <a class="dropdown-item" href="../articles/ep_spec_event_def.html">Endpoint Events</a>
    <a class="dropdown-item" href="../articles/ep_spec_strata_def.html">Strata</a>
    <a class="dropdown-item" href="../articles/ep_spec_label.html">Endpoint Label</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Methods</h6>
    <a class="dropdown-item" href="../articles/methods_criteria.html">Criteria Methods</a>
    <a class="dropdown-item" href="../articles/methods_stat.html">Statistical Methods</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Output Data Model</h6>
    <a class="dropdown-item" href="../articles/results_datamodel.html">Result Data Model</a>
    <a class="dropdown-item" href="../articles/results_datamodel2tfl.html">Mapping Results to TFLs</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Examples</h6>
    <a class="dropdown-item" href="../articles/example_ep_spec.html">Endpoint Catalog</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Debugging</h6>
    <a class="dropdown-item" href="../articles/debugging.html">Debugging</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-contributing">Contributing</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-contributing">
    <a class="dropdown-item" href="../articles/dev_contribute.html">Contributing overview</a>
    <a class="dropdown-item" href="../articles/dev_devops.html">DevOps</a>
    <a class="dropdown-item" href="../articles/qc.html">Quality control</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/hta-pharma/ramnog/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Debugging</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/hta-pharma/ramnog/blob/HEAD/vignettes/debugging.Rmd" class="external-link"><code>vignettes/debugging.Rmd</code></a></small>
      <div class="d-none name"><code>debugging.Rmd</code></div>
    </div>

    
    
<p>Debugging a {chef} pipeline is different than debugging normal R
scripts or functions. This is because under the hood, {chef} makes heavy
use of the {<a href="https://books.ropensci.org/targets/" class="external-link">targets</a>}
package.</p>
<p>We present here two main approaches to debugging:</p>
<ul>
<li>Use the {chef} helper functions</li>
<li>Use the {<a href="https://books.ropensci.org/targets/" class="external-link">targets</a>}
helper functions</li>
</ul>
<p>The {chef} debugging helper functions are best for normal debugging
situations, while using the {targets} helper functions may be needed for
more in-depth debugging sessions.</p>
<div class="section level2">
<h2 id="context---why-debugging-is-different">Context - why debugging is different<a class="anchor" aria-label="anchor" href="#context---why-debugging-is-different"></a>
</h2>
<p>In a {chef} pipeline, the execution environment is managed by {<a href="https://books.ropensci.org/targets/" class="external-link">targets</a>}, and does
<strong>not</strong> take place in your working environment. As a
side-effect, it is not be as straightforward to reproduce errors or
trace them back to their source. Specifically:</p>
<ul>
<li><p>Each target in a {targets} pipeline is run in an new R session
that closes upon completion or hitting an error. This means that the
working environment is clean for every run, which is beneficial for
reproducibility but can make it harder to debug because the state that
led to an error might not be readily accessible.</p></li>
<li><p>{targets} uses a caching mechanism to avoid re-running successful
tasks. While this feature enhances efficiency, it can make debugging
tricky. Understanding whether a bug is due to current code or cached
results might not be straightforward</p></li>
<li><p>Sometimes, the error messages from a {targets} pipeline can be
cryptic or not very informative, making it harder to figure out what’s
going wrong.</p></li>
<li><p>Debugging often requires interactively running code to inspect
objects and their states. However, {targets} is designed for
non-interactive batch (and sometimes parallel) execution, which can make
interactive debugging less straightforward. For example, you cannot just
insert a <code><a href="https://rdrr.io/r/base/browser.html" class="external-link">browser()</a></code> into the function that errored out like
you would in interactive debugging.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="chef-style-debugging">{chef} style debugging<a class="anchor" aria-label="anchor" href="#chef-style-debugging"></a>
</h2>
<p>The most common errors will be due to errors stemming from improper
user inputs (e.g. the user-supplied functions that that generate the
input ADaM datasets, or contain the statistical methods). To debug
these, it is easiest if the programmer has access to the state of the
program at the time it errored-out.</p>
<p>Errors stemming from user function are split into two types:</p>
<ul>
<li><p>Firstly, those relating to the function formals or more
specifically whether the function inputs will match with those supplied
by {chef}.</p></li>
<li><p>Secondly, errors which arise during the evaluation of the
function and validation of its output. These errors can come from bug in
the functions causing crashing at runtime, or functions which return an
invalid output.</p></li>
</ul>
<div class="section level3">
<h3 id="input-errors">Input errors<a class="anchor" aria-label="anchor" href="#input-errors"></a>
</h3>
<p>Input errors stems from mismatch between the expected arguments of a
function and those arguments which {chef} supplies. Errors in this
domain could stem from improperly defined statistical functions or for
instance statistical functions applied to wrong statistical types in the
endpoint specification.</p>
<p>For each function that the user can define {chef} supplies a
predefined set of arguments (<a href="ep_spec_adam_data.html#overview">data</a>, <a href="methods_stat.html#input-specifications-and-examples">statistics</a>,
<a href="methods_criteria.html#input-specifications">criteria</a>).
These arguments are always supplied, why function must either have an
exhaustive function definition, or as <em>recommended</em> include dots
(…) in the function definition to allow the functions to ignore those
arguments, which are not required by the specific function.</p>
<div class="section level5">
<h5 id="examples">Examples:<a class="anchor" aria-label="anchor" href="#examples"></a>
</h5>
<p>An <strong>over-defined function</strong> is a function which require
arguments which are not supplied.</p>
<pre><code># Given a data_prepare function:
my_data &lt;- function(study_metadata, specific_arg){
  #...
}

# Would give rise to the following error:

Function (my_data) of type (data_prepare) expects argument(s) which is not supplied:
    specific_arg
Supplied arguments:
    study_metadata
Expected arguments: (required, [optional])
    specific_arg, study_metadata []</code></pre>
<p>In the above example, the expect-but-no-supplied argument
<code>specific_arg</code> is clearly described as well as those
arguments {chef} supplies (<code>study_metadata</code>) and the full
function argument specification.</p>
<hr>
<p>An <strong>under-defined function</strong> is a function which does
not explicitly require all the supplied arguments and also doesn’t have
dots (…) included to catch surplus arguments.</p>
<pre><code># Given a data_prepare function:
my_data &lt;- function(arg_w_default=2){
  #...
}

# Would give rise to the following error:

Function (my_data) of type (data_prepare) is supplied arguments it does not expect:
    study_metadata
Supplied arguments:
    study_metadata
Expected arguments: (required, [optional])
     [my_def_arg]
Either state all supplied args explicitely or use dots (...) as a passthrough (recommended).
</code></pre>
<p>In the under-defined example the function does not expect the
supplied <code>study_metadata</code> argument. This example also shows
how optional arguments (with default values) are displayed.</p>
</div>
</div>
<div class="section level3">
<h3 id="evaluation-and-validation-errors">Evaluation and validation errors<a class="anchor" aria-label="anchor" href="#evaluation-and-validation-errors"></a>
</h3>
<p>{chef} has built-in helpers that provide the user the state of the
pipeline when a user-supplied function errors-out. By using these
helpers, the programmer can access the workspace (i.e., all objects and
functions) at the point of the error. Then they can debug interactively
like normal R debugging.</p>
<p>In broad terms {chef} will supply the user with the function and
input parameters that lead to an erroneous evaluation. {chef} will
supply debugging sessions if the function crashes or if the function
output is not compliant. (<a href="methods_stat.html#output-specification-shared-for-all-types">Statistical
output</a>, <a href="methods_criteria.html#output-specifications">Criterion
output</a>)</p>
<p>For failures during the evaluation the error message will contain the
keyword <code>EVALUATE</code> while non-conforming outputs will result
in errors with the <code>VALIDATE</code> keyword. Sample error messages
can be seen in the following.</p>
<pre><code># Error message wrt. validation

Error during evaluation of: log(1)
Failed to VALIDATE function output with error:
Expected (data.table::data.table) Found: numeric

# Error message wrt. evaluation

Error during evaluation of: P-interaction
Failed to EVALUATE function with error:
 Error : argument "cell_index" is missing, with no default</code></pre>
<div class="section level5">
<h5 id="debugging-session">Debugging session:<a class="anchor" aria-label="anchor" href="#debugging-session"></a>
</h5>
<p>When an evaluation fails or the output is non-compliant {chef} will
collect the inputs to the function and the function and write it to file
as a new environment object.</p>
<p>The debugging environment will be written to a debugging subfolder of
the current working directory as an .RDS file. The problem can then be
investigated using the built-in function
<code><a href="https://hta-pharma.github.io/chef/reference/load_debug_session.html" class="external-link">chef::load_debug_session()</a></code> or by loading it directly into
your session using <code><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS()</a></code>.</p>
</div>
<div class="section level5">
<h5 id="debugging-example">Debugging example:<a class="anchor" aria-label="anchor" href="#debugging-example"></a>
</h5>
<p>In this example we will review the debugging flow for a faulty stat
method.</p>
<ol style="list-style-type: decimal">
<li>We define an endpoint with a single statistic.</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mk_ep_def</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>              <span class="va">ep</span>  <span class="op">&lt;-</span> <span class="fu">chef</span><span class="fu">::</span><span class="fu"><a href="https://hta-pharma.github.io/chef/reference/mk_endpoint_str.html" class="external-link">mk_endpoint_str</a></span><span class="op">(</span></span>
<span>                <span class="va">...</span>, <span class="co"># The rest of the input parameters.</span></span>
<span>                stat_by_strata_by_trt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"n_sub"</span> <span class="op">=</span> <span class="va">n_sub</span><span class="op">)</span>,</span>
<span>              <span class="op">)</span></span>
<span>            <span class="op">}</span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li><p>We then setup the pipeline as described in <a href="example_end2end.html">End-to-End examples</a>.</p></li>
<li><p>We execute the pipeline with <code>tar_make()</code></p></li>
</ol>
<p>We can then check the output messages from the target run: The
<code>▶</code> indicates a starting target evaluation and
<code>●</code>, <code>✖</code> indicates a successful and failed
evaluation respectably.</p>
<p><strong>Console output</strong></p>
<pre><code>tar_make()
Loading required package: targets
▶ start target ep
● built target ep [0.038 seconds]
▶ start target ep_id
● built target ep_id [0.001 seconds]
(...) # We ignore some other upstream target evaluations.
▶ start target ep_stat_by_strata_by_trt
✖ error target ep_stat_by_strata_by_trt
▶ end pipeline [3.556 seconds]
Error: Error running targets::tar_make()
  Error messages: targets::tar_meta(fields = error, complete_only = TRUE)
  Debugging guide: https://books.ropensci.org/targets/debugging.html
  How to ask for help: https://books.ropensci.org/targets/help.html
  Last error: 
Error during evaluation of: n_sub
Failed to EVALUATE function with error:
 Error in fn_callable[[1]](dat = dat[[1]], treatment_var = treatment_var,  : 
  Calculation impossible!

---
Debugging session created: Launch with:
 chef::load_debug_session('/tmp/RtmpCiXPPf/testproj275bcd76287e8d/debug/n_sub.Rdata')
---</code></pre>
<p>You can see that the pipeline failed during the evaluation of the
target-step <code>ep_stat_by_strata_by_trt</code>. Furthermore, you can
view the <code>Last error</code> to get a meaningful error message. Here
it shows that it failed to evaluate the function aliased
<code>n_sub</code> and an error with the message
<code>Calculation impossible</code></p>
<p>We can inspect the problem further running the suggested command: -
<code>chef::load_debug_session('/tmp/RtmpCiXPPf/testproj275bcd76287e8d/debug/n_sub.Rdata')</code></p>
<p><img src="figures/debug_example.png" width="100%"></p>
<p>We can then play around with the function, given the supplied
inputs.</p>
<p>In this toy example we simply have a function which throws an error -
a simple error to fix. However, this tool provides you with the
possiblity to explore and tinker with your functions in the context
which they fail in the pipeline. NB. as mentioned in the console message
- remember to update you changes to the source code!</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="targets-style-debugging">Targets style debugging<a class="anchor" aria-label="anchor" href="#targets-style-debugging"></a>
</h2>
<p>There are several approaches to debugging a pipeline that is erroring
out. Find much more details in the <a href="https://books.ropensci.org/targets/debugging.html" class="external-link">targets
manual</a>:</p>
<ul>
<li><p>In a clean R session, load the inputs to the target that is
producing the error via
<code>tar_load(names = c(&lt;target_names))</code> then debug the
function for the target interactively like you would debug an other R
function</p></li>
<li><p>Run <code>tar_make(callr_function = NULL)</code> instead of the
usual <code>tar_make</code>. This executes the pipeline in the current R
session rather than a seperate R process, then you can debug
interactively using standard R debugging approaches.</p></li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Matthew David Phelps, Nicolai Skov Johnsen, Henrik Sparre Spiegelhauer, Christian Haargaard Olsen.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.8.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
